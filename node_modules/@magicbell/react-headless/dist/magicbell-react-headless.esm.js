import t,{useEffect as e,useState as r}from"react";import n from"zustand/vanilla";import o from"zustand";import i from"humps";import s from"axios";import a from"immer";import{mergeRight as c,uniqBy as u,isNil as f,findIndex as l,propEq as d}from"ramda";import*as v from"ably";import m from"mitt";import h from"dayjs";import p from"dayjs/plugin/localizedFormat";import A from"dayjs/plugin/relativeTime";import y from"dayjs/plugin/updateLocale";function P(){return(P=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}return t}).apply(this,arguments)}function g(t,e){return(g=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function S(t,e){if(null==t)return{};var r,n,o={},i=Object.keys(t);for(n=0;n<i.length;n++)e.indexOf(r=i[n])>=0||(o[r]=t[r]);return o}var k=n(function(){return{apiKey:"",apiSecret:void 0,userEmail:void 0,userExternalId:void 0,userKey:void 0,clientId:Math.random().toString(36).substring(2)+Date.now(),serverURL:"https://api.magicbell.com"}}),w="__MAGICBELL_HOOKS__",O="undefined"==typeof window?global:window,U={get:function(t,e){return O[w]&&O[w][t]?O[w][t]:e},set:function(t,e){O[w]=O[w]||{},O[w][t]=e}};function E(){var t=k.getState(),e=t.apiSecret,r=t.userEmail,n=t.userExternalId,o=t.userKey,i={"X-MAGICBELL-CLIENT-ID":t.clientId,"X-MAGICBELL-API-KEY":t.apiKey,"X-MagicBell-Client":"ReactHeadless/4.0.0"};return e&&(i["X-MAGICBELL-API-SECRET"]=e),r&&(i["X-MAGICBELL-USER-EMAIL"]=r),o&&(i["X-MAGICBELL-USER-HMAC"]=o),n&&(i["X-MAGICBELL-USER-EXTERNAL-ID"]=n),i}function C(t,e,r,n,o){void 0===o&&(o={});var i=k.getState().serverURL,a=P({},E(),o);return U.get("axios",s)({method:t,url:e,data:r,params:n,headers:a,baseURL:i}).then(function(t){return t.data},function(t){throw t})}function R(t,e,r){return void 0===e&&(e={}),C("get",t,void 0,e,r)}function x(t,e,r,n){return void 0===e&&(e={}),void 0===r&&(r={}),C("post",t,e,r,n)}function L(t,e,r){return void 0===e&&(e={}),C("delete",t,void 0,e,r)}function _(t,e,r,n){return void 0===r&&(r={}),C("put",t,e,r,n)}var b=/*#__PURE__*/function(){function t(t){void 0===t&&(t="/config"),this.remotePathOrUrl=void 0,this.remotePathOrUrl=t}return t.prototype.get=function(){try{return Promise.resolve(R(this.remotePathOrUrl)).then(function(t){return i.camelizeKeys(t)})}catch(t){return Promise.reject(t)}},t}(),j=o(function(t,e){return{channels:void 0,inbox:void 0,ws:void 0,lastFetchedAt:void 0,_repository:new b,fetch:function(){try{var r=e();return Promise.resolve(r._repository.get()).then(function(e){t(P({},e,{lastFetchedAt:Date.now()}))})}catch(t){return Promise.reject(t)}}}}),M=/*#__PURE__*/function(t){var e,r;function n(e){return void 0===e&&(e="/notifications"),t.call(this,e)||this}r=t,(e=n).prototype=Object.create(r.prototype),e.prototype.constructor=e,g(e,r);var o=n.prototype;return o.markAsRead=function(t){return x(this.remotePathOrUrl+"/"+t+"/read").then(function(){return!0}).catch(function(){return!1})},o.markAsUnread=function(t){return x(this.remotePathOrUrl+"/"+t+"/unread").then(function(){return!0}).catch(function(){return!1})},o.markAllAsSeen=function(){return x(this.remotePathOrUrl+"/seen").then(function(){return!0}).catch(function(){return!1})},o.markAllAsRead=function(){return x(this.remotePathOrUrl+"/read").then(function(){return!0}).catch(function(){return!1})},n}(/*#__PURE__*/function(){function t(t){this.remotePathOrUrl=void 0,this.remotePathOrUrl=t}var e=t.prototype;return e.get=function(t){try{return Promise.resolve(R(this.remotePathOrUrl+"/"+t)).then(function(t){return i.camelizeKeys(t)})}catch(t){return Promise.reject(t)}},e.findBy=function(t){try{var e=this;return Promise.resolve(function(r,n){try{var o=Promise.resolve(R(e.remotePathOrUrl,t)).then(function(t){return i.camelizeKeys(t)})}catch(t){return n(t)}return o&&o.then?o.then(void 0,n):o}(0,function(t){if(!/Network Error/.test(t.message))throw t}))}catch(t){return Promise.reject(t)}},e.delete=function(t){return L(this.remotePathOrUrl+"/"+t).then(function(){return!0}).catch(function(){return!1})},t}()),I=m(),N=m();function D(t,e,r){"remote"===r&&I.emit(t,e),N.emit(t,{data:e,source:r})}function F(t){var e=k.getState().clientId,r=t.name.replace(/\//gi,"."),n=t.data;return n.client_id&&n.client_id===e?Promise.resolve(!1):"string"==typeof n.id?"notifications.delete"===r?(D(r,n,"remote"),Promise.resolve(!0)):(new M).get(n.id).then(function(t){return D(r,t.notification,"remote"),!0}):(D(r,n,"remote"),Promise.resolve(!0))}function K(t){return c({context:{},total:0,totalPages:0,perPage:0,currentPage:1,unreadCount:0,unseenCount:0,notifications:[]},t)}var z=["notifications"];function B(t,e){return t===e||t!=t&&e!=e}function X(t){return Array.isArray(t)?t:String(t).split(",")}function G(t,e,r){void 0===r&&(r=B);var n=[];return Object.keys(e).forEach(function(o){var i=e[o];("read"===o&&!r(!f(t.readAt),i)||"seen"===o&&!r(!f(t.seenAt),i)||"categories"===o&&X(i).every(function(e){return!r(t.category,e)})||"topics"===o&&X(i).every(function(e){return!r(t.topic,e)})||Object.hasOwnProperty.call(t,o)&&!r(t[o],i))&&n.push(o)}),{result:0===n.length,delta:n}}var T=o(function(t,e){return{stores:{},_repository:new M,setStore:function(e,r,n){void 0===r&&(r={}),void 0===n&&(n={}),t(a(function(t){t.stores[e]=K(P({},n,{context:r}))}))},fetchStore:function(r,n,o){void 0===n&&(n={}),void 0===o&&(o={});try{var i=e(),s=i._repository,c=i.stores[r];return Promise.resolve(function(){if(c)return Promise.resolve(s.findBy(P({},c.context,n))).then(function(e){e&&t(a(function(t){t.stores[r]=function(t,e,r){void 0===r&&(r={reset:!1});var n=e.notifications,o=S(e,z),i=r.reset?n:u(function(t){return t.id},r.prepend?[].concat(n,t.notifications):[].concat(t.notifications,n));return P({context:t.context,notifications:i},o)}(c,P({},e,{lastFetchedAt:new Date}),o)}))});console.error("Store not found. Define a store with the "+r+" ID")}())}catch(t){return Promise.reject(t)}},fetchAllStores:function(t,r){void 0===t&&(t={}),void 0===r&&(r={});try{var n=e(),o=n.fetchStore,i=Object.keys(n.stores).map(function(e){return o(e,t,r)});return Promise.resolve(Promise.all(i)).then(function(){})}catch(t){return Promise.reject(t)}},markNotificationAsSeen:function(r){var n=e().stores,o=r.id;D("notifications.seen",r,"local"),t(a(function(t){for(var e in n){var r=n[e],i=r.notifications,s=r.unseenCount,a=l(d("id",o),i);a>-1&&(i[a].seenAt||(t.stores[e].unseenCount=Math.max(0,s-1),t.stores[e].notifications[a]=c(i[a],{seenAt:Date.now()/1e3})))}}))},markNotificationAsRead:function(r){var n=e(),o=n.stores,i=r.id,s=n._repository.markAsRead(i);return D("notifications.read",r,"local"),t(a(function(t){var e=Date.now()/1e3,n={readAt:e,seenAt:e};for(var s in o){var a=o[s],u=a.total,f=a.notifications,v=a.context,m=l(d("id",i),f);if(m>-1){r.readAt||(t.stores[s].unreadCount-=1),r.seenAt||(t.stores[s].unseenCount-=1);var h=c(f[m],n);G(h,v).result?t.stores[s].notifications[m]=h:(t.stores[s].total=Math.max(0,u-1),t.stores[s].notifications.splice(m,1))}else{var p=c(r,n);G(p,v).result&&(t.stores[s].total+=1,t.stores[s].notifications.push(p))}}})),s},markNotificationAsUnread:function(r){var n=e(),o=n.stores,i=r.id,s=n._repository.markAsUnread(i);return D("notifications.unread",r,"local"),t(a(function(t){var e={readAt:null};for(var n in o){var s=o[n],a=s.notifications,u=s.context,f=l(d("id",i),a);if(f>-1){var v=c(a[f],e);G(v,u).result?(r.readAt&&(t.stores[n].unreadCount+=1),t.stores[n].notifications[f]=v):(t.stores[n].total-=1,t.stores[n].notifications.splice(f,1))}else{var m=c(r,e);G(m,u).result&&(t.stores[n].total+=1,r.readAt&&(t.stores[n].unreadCount+=1),t.stores[n].notifications.push(m))}}})),s},deleteNotification:function(r,n){void 0===n&&(n={});var o=e(),i=o.stores,s=o._repository,c=r.id,u=Promise.resolve(!0);return!1!==n.persist&&(u=s.delete(c),D("notifications.delete",r,"local")),t(a(function(t){for(var e in i){var r=i[e],n=r.notifications,o=r.total,s=r.unseenCount,a=r.unreadCount,u=l(d("id",c),n);if(u>-1){var f=n[u];f.seenAt||(t.stores[e].unseenCount=Math.max(0,s-1)),f.readAt||(t.stores[e].unreadCount=Math.max(0,a-1)),t.stores[e].total=Math.max(0,o-1),t.stores[e].notifications.splice(u,1)}}})),u},markAllAsSeen:function(r){void 0===r&&(r={persist:!0,updateModels:!0});var n=e(),o=n.stores,i=n._repository,s=Promise.resolve(!0);return!1!==r.persist&&(s=i.markAllAsSeen(),D("notifications.seen.all",null,"local")),t(a(function(t){var e=function(e){var n=o[e].notifications;t.stores[e].unseenCount=0,!1!==r.updateModels&&n.forEach(function(r,n){t.stores[e].notifications[n]=c(r,{seenAt:Date.now()/1e3})})};for(var n in o)e(n)})),s},markAllAsRead:function(r){void 0===r&&(r={persist:!0,updateModels:!0});var n=e(),o=n.stores,i=n._repository,s=Promise.resolve(!0);return!1!==r.persist&&(s=i.markAllAsRead(),D("notifications.read.all",null,"local")),t(a(function(t){var e=function(e){var n=o[e].notifications;if(t.stores[e].unreadCount=0,t.stores[e].unseenCount=0,!1!==r.updateModels){var i=Date.now()/1e3;n.forEach(function(r,n){t.stores[e].notifications[n]=c(r,{readAt:i,seenAt:i})})}};for(var n in o)e(n)})),s}}});function H(t,r,n){void 0===n&&(n={source:"any"}),e(function(){var e=function(t){void 0===t&&(t={}),"remote"===n.source&&"remote"!==t.source||"local"===n.source&&"local"!==t.source||r(t.data,t.source)};return N.on(t,e),function(){N.off(t,e)}},[])}function J(){var t,r=T(),n=function(){return r.fetchAllStores({page:1},{reset:!0})};return t=j(),e(function(){return t.ws?function(t){var e=!1,r=t.channel,n=function(t){var e=k.getState().serverURL+"/"+t.authUrl,r=E();return new v.Realtime({authUrl:e,authHeaders:r,authMethod:"POST",log:{level:0},transports:["web_socket"]})}(t);n.connection.on("suspended",function(t){"disconnected"===t.previous&&D("disconnected",t,"local")}),n.connection.on(function(t){var r=t.current;["suspended","disconnected"].includes(t.previous)&&"connecting"===r&&(e=!0),e&&"connected"===r&&(e=!1,D("reconnected",t,"local"))});var o=n.channels.get(r);return o.subscribe(F),function(){o.unsubscribe(F),o.detach(),n.connection.off(),n.close()}}(t.ws):function(){}},[t.ws]),H("reconnected",n),H("notifications.new",function(){return r.fetchAllStores({page:1},{prepend:!0})},{source:"remote"}),H("notifications.seen.all",function(){return r.markAllAsSeen({persist:!1})},{source:"remote"}),H("notifications.read.all",function(){return r.markAllAsRead({persist:!1})},{source:"remote"}),H("notifications.read",n,{source:"remote"}),H("notifications.unread",n,{source:"remote"}),H("notifications.delete",function(t){return r.deleteNotification(t,{persist:!1})},{source:"remote"}),null}var Q=["serverURL"],V=["children","stores","disableRealtime"];function Y(t){var e=t.serverURL,r=S(t,Q);return e&&(r.serverURL=e),k.setState(r),r}function q(n){var o=n.children,i=n.stores,s=void 0===i?[{id:"default",defaultQueryParams:{}}]:i,a=n.disableRealtime,c=S(n,V);r(function(){return Y(c)}),r(function(){return function(t){var e={};return t.forEach(function(t){var r=t.defaults;e[t.id]=K(P({context:t.defaultQueryParams},void 0===r?{}:r))}),T.setState({stores:e}),e}(s)});var u=j();return e(function(){u.lastFetchedAt||u.fetch()},[u]),t.createElement(t.Fragment,null,a?null:t.createElement(J,null),o)}function W(t){void 0===t&&(t="default");var r=T(),n=r.stores,o=r.fetchStore,i=r.markAllAsSeen,s=r.markAllAsRead,a=j(),c=n[t],u=function(e,r){return o(t,e,r)};return e(function(){c&&a.lastFetchedAt&&!c.lastFetchedAt&&u({page:1})},[a.lastFetchedAt]),c?P({},c,{isEmpty:0===c.notifications.length,hasNextPage:c.currentPage<c.totalPages,fetch:u,fetchNextPage:function(e,r){return void 0===e&&(e={}),o(t,P({},e,{page:c.currentPage+1}),r)},markAllAsSeen:i,markAllAsRead:s}):null}function Z(t){var e=W((void 0===t?{}:t).storeId);return e?P({},e,{markAllAsSeen:function(){return e&&e.unseenCount>0?null==e?void 0:e.markAllAsSeen({updateModels:!1}):Promise.resolve(!0)}}):null}function $(t){return t?tt(1e3*t):null}function tt(t){return h(t)}function et(t){return h(t).unix()}function rt(t){if(f(t))return null;if("string"==typeof t)try{return JSON.parse(t)}catch(t){console.warn('"customAttributes" is not valid JSON')}return t}function nt(t){var e=T(),r=e.markNotificationAsRead,n=e.markNotificationAsSeen,o=e.markNotificationAsUnread,i=e.deleteNotification;return P({},t,{customAttributes:rt(t.customAttributes),readAt:$(t.readAt),seenAt:$(t.seenAt),sentAt:$(t.sentAt),archivedAt:$(t.archivedAt),isSeen:!f(t.seenAt),isRead:!f(t.readAt),isArchived:!f(t.archivedAt),sanitizedContent:t.content,markAsSeen:function(){return n(t)},markAsRead:function(){return r(t)},markAsUnread:function(){return o(t)},delete:function(){return i(t)}})}function ot(t,r){e(function(){return function(){r?r(t):t.markAsSeen()}},[])}function it(t,e){var r=nt(t);return ot(r,e),r}h.extend(p),h.extend(A),h.extend(y);var st=/*#__PURE__*/function(){function t(t){void 0===t&&(t="/notification_preferences"),this.remotePathOrUrl=void 0,this.remotePathOrUrl=t}var e=t.prototype;return e.get=function(){try{return Promise.resolve(R(this.remotePathOrUrl,void 0,{"Accept-Version":"v2"})).then(function(t){return i.camelizeKeys(t)})}catch(t){return Promise.reject(t)}},e.update=function(t){try{var e=this.remotePathOrUrl,r=i.decamelizeKeys({notificationPreferences:t});return Promise.resolve(_(e,r,void 0,{"Accept-Version":"v2"})).then(function(t){return i.camelizeKeys(t)})}catch(t){return Promise.reject(t)}},t}();function at(t,e){try{var r=t()}catch(t){return e(t)}return r&&r.then?r.then(void 0,e):r}var ct=o(function(t,e){return{categories:[],_repository:new st,fetch:function(){try{var r=e()._repository,n=at(function(){return Promise.resolve(r.get()).then(function(e){t(P({},e.notificationPreferences,{lastFetchedAt:Date.now()}))})},function(){t({categories:[],lastFetchedAt:Date.now()})});return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(t){return Promise.reject(t)}},save:function(r){try{var n=e()._repository,o=at(function(){return Promise.resolve(n.update(r)).then(function(e){t(P({},e.notificationPreferences,{lastFetchedAt:Date.now()}))})},function(){t({categories:[],lastFetchedAt:Date.now()})});return Promise.resolve(o&&o.then?o.then(function(){}):void 0)}catch(t){return Promise.reject(t)}}}});export{q as MagicBellProvider,J as RealtimeListener,K as buildStore,k as clientSettings,L as deleteAPI,N as eventAggregator,R as fetchAPI,x as postAPI,I as pushEventAggregator,_ as putAPI,U as registry,$ as secondsToDate,tt as toDate,et as toUnix,Z as useBell,j as useConfig,H as useMagicBellEvent,it as useNotification,nt as useNotificationFactory,ct as useNotificationPreferences,T as useNotificationStoresCollection,ot as useNotificationUnmount,W as useNotifications};
//# sourceMappingURL=magicbell-react-headless.esm.js.map
