!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("react"),require("zustand/vanilla"),require("zustand"),require("humps"),require("axios"),require("immer"),require("ramda"),require("ably"),require("mitt"),require("dayjs"),require("dayjs/plugin/localizedFormat"),require("dayjs/plugin/relativeTime"),require("dayjs/plugin/updateLocale")):"function"==typeof define&&define.amd?define(["exports","react","zustand/vanilla","zustand","humps","axios","immer","ramda","ably","mitt","dayjs","dayjs/plugin/localizedFormat","dayjs/plugin/relativeTime","dayjs/plugin/updateLocale"],t):t((e||self).reactHeadless={},e.react,e.create,e.zustand,e.humps,e.axios,e.immer,e.ramda,e.ably,e.mitt,e.dayjs,e.localizedFormat,e.relativeTime,e.updateLocale)}(this,function(e,t,r,n,o,i,a,s,u,c,f,l,d,v){function h(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function m(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach(function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}}),t.default=e,t}var p=/*#__PURE__*/h(t),A=/*#__PURE__*/h(r),g=/*#__PURE__*/h(n),y=/*#__PURE__*/h(o),P=/*#__PURE__*/h(i),S=/*#__PURE__*/h(a),E=/*#__PURE__*/m(u),O=/*#__PURE__*/h(c),R=/*#__PURE__*/h(f),b=/*#__PURE__*/h(l),x=/*#__PURE__*/h(d),U=/*#__PURE__*/h(v);function k(){return(k=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function w(e,t){return(w=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function j(e,t){if(null==e)return{};var r,n,o={},i=Object.keys(e);for(n=0;n<i.length;n++)t.indexOf(r=i[n])>=0||(o[r]=e[r]);return o}var C=A.default(function(){return{apiKey:"",apiSecret:void 0,userEmail:void 0,userExternalId:void 0,userKey:void 0,clientId:Math.random().toString(36).substring(2)+Date.now(),serverURL:"https://api.magicbell.com"}}),I="__MAGICBELL_HOOKS__",L="undefined"==typeof window?global:window,N={get:function(e,t){return L[I]&&L[I][e]?L[I][e]:t},set:function(e,t){L[I]=L[I]||{},L[I][e]=t}};function _(){var e=C.getState(),t=e.apiSecret,r=e.userEmail,n=e.userExternalId,o=e.userKey,i={"X-MAGICBELL-CLIENT-ID":e.clientId,"X-MAGICBELL-API-KEY":e.apiKey,"X-MagicBell-Client":"ReactHeadless/4.0.0"};return t&&(i["X-MAGICBELL-API-SECRET"]=t),r&&(i["X-MAGICBELL-USER-EMAIL"]=r),o&&(i["X-MAGICBELL-USER-HMAC"]=o),n&&(i["X-MAGICBELL-USER-EXTERNAL-ID"]=n),i}function M(e,t,r,n,o){void 0===o&&(o={});var i=C.getState().serverURL,a=k({},_(),o);return N.get("axios",P.default)({method:e,url:t,data:r,params:n,headers:a,baseURL:i}).then(function(e){return e.data},function(e){throw e})}function q(e,t,r){return void 0===t&&(t={}),M("get",e,void 0,t,r)}function D(e,t,r,n){return void 0===t&&(t={}),void 0===r&&(r={}),M("post",e,t,r,n)}function F(e,t,r){return void 0===t&&(t={}),M("delete",e,void 0,t,r)}function z(e,t,r,n){return void 0===r&&(r={}),M("put",e,t,r,n)}var B=/*#__PURE__*/function(){function e(e){void 0===e&&(e="/config"),this.remotePathOrUrl=void 0,this.remotePathOrUrl=e}return e.prototype.get=function(){try{return Promise.resolve(q(this.remotePathOrUrl)).then(function(e){return y.default.camelizeKeys(e)})}catch(e){return Promise.reject(e)}},e}(),K=g.default(function(e,t){return{channels:void 0,inbox:void 0,ws:void 0,lastFetchedAt:void 0,_repository:new B,fetch:function(){try{var r=t();return Promise.resolve(r._repository.get()).then(function(t){e(k({},t,{lastFetchedAt:Date.now()}))})}catch(e){return Promise.reject(e)}}}}),T=/*#__PURE__*/function(e){var t,r;function n(t){return void 0===t&&(t="/notifications"),e.call(this,t)||this}r=e,(t=n).prototype=Object.create(r.prototype),t.prototype.constructor=t,w(t,r);var o=n.prototype;return o.markAsRead=function(e){return D(this.remotePathOrUrl+"/"+e+"/read").then(function(){return!0}).catch(function(){return!1})},o.markAsUnread=function(e){return D(this.remotePathOrUrl+"/"+e+"/unread").then(function(){return!0}).catch(function(){return!1})},o.markAllAsSeen=function(){return D(this.remotePathOrUrl+"/seen").then(function(){return!0}).catch(function(){return!1})},o.markAllAsRead=function(){return D(this.remotePathOrUrl+"/read").then(function(){return!0}).catch(function(){return!1})},n}(/*#__PURE__*/function(){function e(e){this.remotePathOrUrl=void 0,this.remotePathOrUrl=e}var t=e.prototype;return t.get=function(e){try{return Promise.resolve(q(this.remotePathOrUrl+"/"+e)).then(function(e){return y.default.camelizeKeys(e)})}catch(e){return Promise.reject(e)}},t.findBy=function(e){try{var t=this;return Promise.resolve(function(r,n){try{var o=Promise.resolve(q(t.remotePathOrUrl,e)).then(function(e){return y.default.camelizeKeys(e)})}catch(e){return n(e)}return o&&o.then?o.then(void 0,n):o}(0,function(e){if(!/Network Error/.test(e.message))throw e}))}catch(e){return Promise.reject(e)}},t.delete=function(e){return F(this.remotePathOrUrl+"/"+e).then(function(){return!0}).catch(function(){return!1})},e}()),X=O.default(),G=O.default();function H(e,t,r){"remote"===r&&X.emit(e,t),G.emit(e,{data:t,source:r})}function J(e){var t=C.getState().clientId,r=e.name.replace(/\//gi,"."),n=e.data;return n.client_id&&n.client_id===t?Promise.resolve(!1):"string"==typeof n.id?"notifications.delete"===r?(H(r,n,"remote"),Promise.resolve(!0)):(new T).get(n.id).then(function(e){return H(r,e.notification,"remote"),!0}):(H(r,n,"remote"),Promise.resolve(!0))}function Q(e){return s.mergeRight({context:{},total:0,totalPages:0,perPage:0,currentPage:1,unreadCount:0,unseenCount:0,notifications:[]},e)}var V=["notifications"];function Y(e,t){return e===t||e!=e&&t!=t}function W(e){return Array.isArray(e)?e:String(e).split(",")}function Z(e,t,r){void 0===r&&(r=Y);var n=[];return Object.keys(t).forEach(function(o){var i=t[o];("read"===o&&!r(!s.isNil(e.readAt),i)||"seen"===o&&!r(!s.isNil(e.seenAt),i)||"categories"===o&&W(i).every(function(t){return!r(e.category,t)})||"topics"===o&&W(i).every(function(t){return!r(e.topic,t)})||Object.hasOwnProperty.call(e,o)&&!r(e[o],i))&&n.push(o)}),{result:0===n.length,delta:n}}var $=g.default(function(e,t){return{stores:{},_repository:new T,setStore:function(t,r,n){void 0===r&&(r={}),void 0===n&&(n={}),e(S.default(function(e){e.stores[t]=Q(k({},n,{context:r}))}))},fetchStore:function(r,n,o){void 0===n&&(n={}),void 0===o&&(o={});try{var i=t(),a=i._repository,u=i.stores[r];return Promise.resolve(function(){if(u)return Promise.resolve(a.findBy(k({},u.context,n))).then(function(t){t&&e(S.default(function(e){e.stores[r]=function(e,t,r){void 0===r&&(r={reset:!1});var n=t.notifications,o=j(t,V),i=r.reset?n:s.uniqBy(function(e){return e.id},r.prepend?[].concat(n,e.notifications):[].concat(e.notifications,n));return k({context:e.context,notifications:i},o)}(u,k({},t,{lastFetchedAt:new Date}),o)}))});console.error("Store not found. Define a store with the "+r+" ID")}())}catch(e){return Promise.reject(e)}},fetchAllStores:function(e,r){void 0===e&&(e={}),void 0===r&&(r={});try{var n=t(),o=n.fetchStore,i=Object.keys(n.stores).map(function(t){return o(t,e,r)});return Promise.resolve(Promise.all(i)).then(function(){})}catch(e){return Promise.reject(e)}},markNotificationAsSeen:function(r){var n=t().stores,o=r.id;H("notifications.seen",r,"local"),e(S.default(function(e){for(var t in n){var r=n[t],i=r.notifications,a=r.unseenCount,u=s.findIndex(s.propEq("id",o),i);u>-1&&(i[u].seenAt||(e.stores[t].unseenCount=Math.max(0,a-1),e.stores[t].notifications[u]=s.mergeRight(i[u],{seenAt:Date.now()/1e3})))}}))},markNotificationAsRead:function(r){var n=t(),o=n.stores,i=r.id,a=n._repository.markAsRead(i);return H("notifications.read",r,"local"),e(S.default(function(e){var t=Date.now()/1e3,n={readAt:t,seenAt:t};for(var a in o){var u=o[a],c=u.total,f=u.notifications,l=u.context,d=s.findIndex(s.propEq("id",i),f);if(d>-1){r.readAt||(e.stores[a].unreadCount-=1),r.seenAt||(e.stores[a].unseenCount-=1);var v=s.mergeRight(f[d],n);Z(v,l).result?e.stores[a].notifications[d]=v:(e.stores[a].total=Math.max(0,c-1),e.stores[a].notifications.splice(d,1))}else{var h=s.mergeRight(r,n);Z(h,l).result&&(e.stores[a].total+=1,e.stores[a].notifications.push(h))}}})),a},markNotificationAsUnread:function(r){var n=t(),o=n.stores,i=r.id,a=n._repository.markAsUnread(i);return H("notifications.unread",r,"local"),e(S.default(function(e){var t={readAt:null};for(var n in o){var a=o[n],u=a.notifications,c=a.context,f=s.findIndex(s.propEq("id",i),u);if(f>-1){var l=s.mergeRight(u[f],t);Z(l,c).result?(r.readAt&&(e.stores[n].unreadCount+=1),e.stores[n].notifications[f]=l):(e.stores[n].total-=1,e.stores[n].notifications.splice(f,1))}else{var d=s.mergeRight(r,t);Z(d,c).result&&(e.stores[n].total+=1,r.readAt&&(e.stores[n].unreadCount+=1),e.stores[n].notifications.push(d))}}})),a},deleteNotification:function(r,n){void 0===n&&(n={});var o=t(),i=o.stores,a=o._repository,u=r.id,c=Promise.resolve(!0);return!1!==n.persist&&(c=a.delete(u),H("notifications.delete",r,"local")),e(S.default(function(e){for(var t in i){var r=i[t],n=r.notifications,o=r.total,a=r.unseenCount,c=r.unreadCount,f=s.findIndex(s.propEq("id",u),n);if(f>-1){var l=n[f];l.seenAt||(e.stores[t].unseenCount=Math.max(0,a-1)),l.readAt||(e.stores[t].unreadCount=Math.max(0,c-1)),e.stores[t].total=Math.max(0,o-1),e.stores[t].notifications.splice(f,1)}}})),c},markAllAsSeen:function(r){void 0===r&&(r={persist:!0,updateModels:!0});var n=t(),o=n.stores,i=n._repository,a=Promise.resolve(!0);return!1!==r.persist&&(a=i.markAllAsSeen(),H("notifications.seen.all",null,"local")),e(S.default(function(e){var t=function(t){var n=o[t].notifications;e.stores[t].unseenCount=0,!1!==r.updateModels&&n.forEach(function(r,n){e.stores[t].notifications[n]=s.mergeRight(r,{seenAt:Date.now()/1e3})})};for(var n in o)t(n)})),a},markAllAsRead:function(r){void 0===r&&(r={persist:!0,updateModels:!0});var n=t(),o=n.stores,i=n._repository,a=Promise.resolve(!0);return!1!==r.persist&&(a=i.markAllAsRead(),H("notifications.read.all",null,"local")),e(S.default(function(e){var t=function(t){var n=o[t].notifications;if(e.stores[t].unreadCount=0,e.stores[t].unseenCount=0,!1!==r.updateModels){var i=Date.now()/1e3;n.forEach(function(r,n){e.stores[t].notifications[n]=s.mergeRight(r,{readAt:i,seenAt:i})})}};for(var n in o)t(n)})),a}}});function ee(e,r,n){void 0===n&&(n={source:"any"}),t.useEffect(function(){var t=function(e){void 0===e&&(e={}),"remote"===n.source&&"remote"!==e.source||"local"===n.source&&"local"!==e.source||r(e.data,e.source)};return G.on(e,t),function(){G.off(e,t)}},[])}function te(){var e,r=$(),n=function(){return r.fetchAllStores({page:1},{reset:!0})};return e=K(),t.useEffect(function(){return e.ws?function(e){var t=!1,r=e.channel,n=function(e){var t=C.getState().serverURL+"/"+e.authUrl,r=_();return new E.Realtime({authUrl:t,authHeaders:r,authMethod:"POST",log:{level:0},transports:["web_socket"]})}(e);n.connection.on("suspended",function(e){"disconnected"===e.previous&&H("disconnected",e,"local")}),n.connection.on(function(e){var r=e.current;["suspended","disconnected"].includes(e.previous)&&"connecting"===r&&(t=!0),t&&"connected"===r&&(t=!1,H("reconnected",e,"local"))});var o=n.channels.get(r);return o.subscribe(J),function(){o.unsubscribe(J),o.detach(),n.connection.off(),n.close()}}(e.ws):function(){}},[e.ws]),ee("reconnected",n),ee("notifications.new",function(){return r.fetchAllStores({page:1},{prepend:!0})},{source:"remote"}),ee("notifications.seen.all",function(){return r.markAllAsSeen({persist:!1})},{source:"remote"}),ee("notifications.read.all",function(){return r.markAllAsRead({persist:!1})},{source:"remote"}),ee("notifications.read",n,{source:"remote"}),ee("notifications.unread",n,{source:"remote"}),ee("notifications.delete",function(e){return r.deleteNotification(e,{persist:!1})},{source:"remote"}),null}var re=["serverURL"],ne=["children","stores","disableRealtime"];function oe(e){var t=e.serverURL,r=j(e,re);return t&&(r.serverURL=t),C.setState(r),r}function ie(e){void 0===e&&(e="default");var r=$(),n=r.stores,o=r.fetchStore,i=r.markAllAsSeen,a=r.markAllAsRead,s=K(),u=n[e],c=function(t,r){return o(e,t,r)};return t.useEffect(function(){u&&s.lastFetchedAt&&!u.lastFetchedAt&&c({page:1})},[s.lastFetchedAt]),u?k({},u,{isEmpty:0===u.notifications.length,hasNextPage:u.currentPage<u.totalPages,fetch:c,fetchNextPage:function(t,r){return void 0===t&&(t={}),o(e,k({},t,{page:u.currentPage+1}),r)},markAllAsSeen:i,markAllAsRead:a}):null}function ae(e){return e?se(1e3*e):null}function se(e){return R.default(e)}function ue(e){if(s.isNil(e))return null;if("string"==typeof e)try{return JSON.parse(e)}catch(e){console.warn('"customAttributes" is not valid JSON')}return e}function ce(e){var t=$(),r=t.markNotificationAsRead,n=t.markNotificationAsSeen,o=t.markNotificationAsUnread,i=t.deleteNotification;return k({},e,{customAttributes:ue(e.customAttributes),readAt:ae(e.readAt),seenAt:ae(e.seenAt),sentAt:ae(e.sentAt),archivedAt:ae(e.archivedAt),isSeen:!s.isNil(e.seenAt),isRead:!s.isNil(e.readAt),isArchived:!s.isNil(e.archivedAt),sanitizedContent:e.content,markAsSeen:function(){return n(e)},markAsRead:function(){return r(e)},markAsUnread:function(){return o(e)},delete:function(){return i(e)}})}function fe(e,r){t.useEffect(function(){return function(){r?r(e):e.markAsSeen()}},[])}R.default.extend(b.default),R.default.extend(x.default),R.default.extend(U.default);var le=/*#__PURE__*/function(){function e(e){void 0===e&&(e="/notification_preferences"),this.remotePathOrUrl=void 0,this.remotePathOrUrl=e}var t=e.prototype;return t.get=function(){try{return Promise.resolve(q(this.remotePathOrUrl,void 0,{"Accept-Version":"v2"})).then(function(e){return y.default.camelizeKeys(e)})}catch(e){return Promise.reject(e)}},t.update=function(e){try{var t=this.remotePathOrUrl,r=y.default.decamelizeKeys({notificationPreferences:e});return Promise.resolve(z(t,r,void 0,{"Accept-Version":"v2"})).then(function(e){return y.default.camelizeKeys(e)})}catch(e){return Promise.reject(e)}},e}();function de(e,t){try{var r=e()}catch(e){return t(e)}return r&&r.then?r.then(void 0,t):r}var ve=g.default(function(e,t){return{categories:[],_repository:new le,fetch:function(){try{var r=t()._repository,n=de(function(){return Promise.resolve(r.get()).then(function(t){e(k({},t.notificationPreferences,{lastFetchedAt:Date.now()}))})},function(){e({categories:[],lastFetchedAt:Date.now()})});return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},save:function(r){try{var n=t()._repository,o=de(function(){return Promise.resolve(n.update(r)).then(function(t){e(k({},t.notificationPreferences,{lastFetchedAt:Date.now()}))})},function(){e({categories:[],lastFetchedAt:Date.now()})});return Promise.resolve(o&&o.then?o.then(function(){}):void 0)}catch(e){return Promise.reject(e)}}}});e.MagicBellProvider=function(e){var r=e.children,n=e.stores,o=void 0===n?[{id:"default",defaultQueryParams:{}}]:n,i=e.disableRealtime,a=j(e,ne);t.useState(function(){return oe(a)}),t.useState(function(){return function(e){var t={};return e.forEach(function(e){var r=e.defaults;t[e.id]=Q(k({context:e.defaultQueryParams},void 0===r?{}:r))}),$.setState({stores:t}),t}(o)});var s=K();return t.useEffect(function(){s.lastFetchedAt||s.fetch()},[s]),p.default.createElement(p.default.Fragment,null,i?null:p.default.createElement(te,null),r)},e.RealtimeListener=te,e.buildStore=Q,e.clientSettings=C,e.deleteAPI=F,e.eventAggregator=G,e.fetchAPI=q,e.postAPI=D,e.pushEventAggregator=X,e.putAPI=z,e.registry=N,e.secondsToDate=ae,e.toDate=se,e.toUnix=function(e){return R.default(e).unix()},e.useBell=function(e){var t=ie((void 0===e?{}:e).storeId);return t?k({},t,{markAllAsSeen:function(){return t&&t.unseenCount>0?null==t?void 0:t.markAllAsSeen({updateModels:!1}):Promise.resolve(!0)}}):null},e.useConfig=K,e.useMagicBellEvent=ee,e.useNotification=function(e,t){var r=ce(e);return fe(r,t),r},e.useNotificationFactory=ce,e.useNotificationPreferences=ve,e.useNotificationStoresCollection=$,e.useNotificationUnmount=fe,e.useNotifications=ie});
//# sourceMappingURL=magicbell-react-headless.umd.js.map
