import t,{useEffect as e,useState as n}from"react";import o from"zustand/vanilla";import r from"zustand";import s from"humps";import i from"axios";import a from"immer";import{mergeRight as c,uniqBy as l,isNil as u,findIndex as d,propEq as f}from"ramda";import*as m from"ably";import h from"mitt";import A from"dayjs";import p from"dayjs/plugin/localizedFormat";import y from"dayjs/plugin/relativeTime";import g from"dayjs/plugin/updateLocale";function v(){return(v=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o])}return t}).apply(this,arguments)}function w(t,e){if(null==t)return{};var n,o,r={},s=Object.keys(t);for(o=0;o<s.length;o++)e.indexOf(n=s[o])>=0||(r[n]=t[n]);return r}const P=o(()=>({apiKey:"",apiSecret:void 0,userEmail:void 0,userExternalId:void 0,userKey:void 0,clientId:Math.random().toString(36).substring(2)+Date.now(),serverURL:"https://api.magicbell.com"})),S="__MAGICBELL_HOOKS__",k="undefined"==typeof window?global:window,U={get:(t,e)=>k[S]&&k[S][t]?k[S][t]:e,set(t,e){k[S]=k[S]||{},k[S][t]=e}};function O(){const{apiKey:t,apiSecret:e,clientId:n,userEmail:o,userExternalId:r,userKey:s}=P.getState(),i={"X-MAGICBELL-CLIENT-ID":n,"X-MAGICBELL-API-KEY":t,"X-MagicBell-Client":"ReactHeadless/4.0.0"};return e&&(i["X-MAGICBELL-API-SECRET"]=e),o&&(i["X-MAGICBELL-USER-EMAIL"]=o),s&&(i["X-MAGICBELL-USER-HMAC"]=s),r&&(i["X-MAGICBELL-USER-EXTERNAL-ID"]=r),i}function E(t,e,n,o,r={}){const{serverURL:s}=P.getState(),a=v({},O(),r);return U.get("axios",i)({method:t,url:e,data:n,params:o,headers:a,baseURL:s}).then(t=>t.data,t=>{throw t})}function C(t,e={},n){return E("get",t,void 0,e,n)}function R(t,e={},n={},o){return E("post",t,e,n,o)}function x(t,e={},n){return E("delete",t,void 0,e,n)}function L(t,e,n={},o){return E("put",t,e,n,o)}class b{constructor(t="/config"){this.remotePathOrUrl=void 0,this.remotePathOrUrl=t}async get(){const t=await C(this.remotePathOrUrl);return s.camelizeKeys(t)}}const M=r((t,e)=>({channels:void 0,inbox:void 0,ws:void 0,lastFetchedAt:void 0,_repository:new b,fetch:async()=>{const{_repository:n}=e(),o=await n.get();t(v({},o,{lastFetchedAt:Date.now()}))}}));class _ extends class{constructor(t){this.remotePathOrUrl=void 0,this.remotePathOrUrl=t}async get(t){const e=`${this.remotePathOrUrl}/${t}`,n=await C(e);return s.camelizeKeys(n)}async findBy(t){try{const e=await C(this.remotePathOrUrl,t);return s.camelizeKeys(e)}catch(t){if(/Network Error/.test(t.message))return;throw t}}delete(t){return x(`${this.remotePathOrUrl}/${t}`).then(()=>!0).catch(()=>!1)}}{constructor(t="/notifications"){super(t)}markAsRead(t){return R(`${this.remotePathOrUrl}/${t}/read`).then(()=>!0).catch(()=>!1)}markAsUnread(t){return R(`${this.remotePathOrUrl}/${t}/unread`).then(()=>!0).catch(()=>!1)}markAllAsSeen(){return R(`${this.remotePathOrUrl}/seen`).then(()=>!0).catch(()=>!1)}markAllAsRead(){return R(`${this.remotePathOrUrl}/read`).then(()=>!0).catch(()=>!1)}}const I=h(),N=h();function D(t,e,n){"remote"===n&&I.emit(t,e),N.emit(t,{data:e,source:n})}function F(t){const{clientId:e}=P.getState(),n=t.name.replace(/\//gi,"."),o=t.data;return o.client_id&&o.client_id===e?Promise.resolve(!1):"string"==typeof o.id?"notifications.delete"===n?(D(n,o,"remote"),Promise.resolve(!0)):(new _).get(o.id).then(t=>(D(n,t.notification,"remote"),!0)):(D(n,o,"remote"),Promise.resolve(!0))}function $(t){return c({context:{},total:0,totalPages:0,perPage:0,currentPage:1,unreadCount:0,unseenCount:0,notifications:[]},t)}const K=["notifications"];function j(t,e){return t===e||t!=t&&e!=e}function z(t){return Array.isArray(t)?t:String(t).split(",")}function B(t,e,n=j){const o=[];return Object.keys(e).forEach(r=>{const s=e[r];("read"===r&&!n(!u(t.readAt),s)||"seen"===r&&!n(!u(t.seenAt),s)||"categories"===r&&z(s).every(e=>!n(t.category,e))||"topics"===r&&z(s).every(e=>!n(t.topic,e))||Object.hasOwnProperty.call(t,r)&&!n(t[r],s))&&o.push(r)}),{result:0===o.length,delta:o}}const X=r((t,e)=>({stores:{},_repository:new _,setStore:(e,n={},o={})=>{t(a(t=>{t.stores[e]=$(v({},o,{context:n}))}))},fetchStore:async(n,o={},r={})=>{const{stores:s,_repository:i}=e(),c=s[n];if(c){const e=await i.findBy(v({},c.context,o));if(!e)return;t(a(t=>{t.stores[n]=function(t,e,n={reset:!1}){const{notifications:o}=e,r=w(e,K),s=n.reset?o:l(t=>t.id,n.prepend?[...o,...t.notifications]:[...t.notifications,...o]);return v({context:t.context,notifications:s},r)}(c,v({},e,{lastFetchedAt:new Date}),r)}))}else console.error(`Store not found. Define a store with the ${n} ID`)},fetchAllStores:async(t={},n={})=>{const{stores:o,fetchStore:r}=e(),s=Object.keys(o).map(e=>r(e,t,n));await Promise.all(s)},markNotificationAsSeen:n=>{const{stores:o}=e(),r=n.id;D("notifications.seen",n,"local"),t(a(t=>{for(const e in o){const{notifications:n,unseenCount:s}=o[e],i=d(f("id",r),n);i>-1&&(n[i].seenAt||(t.stores[e].unseenCount=Math.max(0,s-1),t.stores[e].notifications[i]=c(n[i],{seenAt:Date.now()/1e3})))}}))},markNotificationAsRead:n=>{const{stores:o,_repository:r}=e(),{id:s}=n,i=r.markAsRead(s);return D("notifications.read",n,"local"),t(a(t=>{const e=Date.now()/1e3,r={readAt:e,seenAt:e};for(const e in o){const{total:i,notifications:a,context:l}=o[e],u=d(f("id",s),a);if(u>-1){n.readAt||(t.stores[e].unreadCount-=1),n.seenAt||(t.stores[e].unseenCount-=1);const o=c(a[u],r);B(o,l).result?t.stores[e].notifications[u]=o:(t.stores[e].total=Math.max(0,i-1),t.stores[e].notifications.splice(u,1))}else{const o=c(n,r);B(o,l).result&&(t.stores[e].total+=1,t.stores[e].notifications.push(o))}}})),i},markNotificationAsUnread:n=>{const{stores:o,_repository:r}=e(),{id:s}=n,i=r.markAsUnread(s);return D("notifications.unread",n,"local"),t(a(t=>{const e={readAt:null};for(const r in o){const{notifications:i,context:a}=o[r],l=d(f("id",s),i);if(l>-1){const o=c(i[l],e);B(o,a).result?(n.readAt&&(t.stores[r].unreadCount+=1),t.stores[r].notifications[l]=o):(t.stores[r].total-=1,t.stores[r].notifications.splice(l,1))}else{const o=c(n,e);B(o,a).result&&(t.stores[r].total+=1,n.readAt&&(t.stores[r].unreadCount+=1),t.stores[r].notifications.push(o))}}})),i},deleteNotification:(n,o={})=>{const{stores:r,_repository:s}=e(),i=n.id;let c=Promise.resolve(!0);return!1!==o.persist&&(c=s.delete(i),D("notifications.delete",n,"local")),t(a(t=>{for(const e in r){const{notifications:n,total:o,unseenCount:s,unreadCount:a}=r[e],c=d(f("id",i),n);if(c>-1){const r=n[c];r.seenAt||(t.stores[e].unseenCount=Math.max(0,s-1)),r.readAt||(t.stores[e].unreadCount=Math.max(0,a-1)),t.stores[e].total=Math.max(0,o-1),t.stores[e].notifications.splice(c,1)}}})),c},markAllAsSeen:(n={persist:!0,updateModels:!0})=>{const{stores:o,_repository:r}=e();let s=Promise.resolve(!0);return!1!==n.persist&&(s=r.markAllAsSeen(),D("notifications.seen.all",null,"local")),t(a(t=>{for(const e in o){const{notifications:r}=o[e];t.stores[e].unseenCount=0,!1!==n.updateModels&&r.forEach((n,o)=>{t.stores[e].notifications[o]=c(n,{seenAt:Date.now()/1e3})})}})),s},markAllAsRead:(n={persist:!0,updateModels:!0})=>{const{stores:o,_repository:r}=e();let s=Promise.resolve(!0);return!1!==n.persist&&(s=r.markAllAsRead(),D("notifications.read.all",null,"local")),t(a(t=>{for(const e in o){const{notifications:r}=o[e];if(t.stores[e].unreadCount=0,t.stores[e].unseenCount=0,!1!==n.updateModels){const n=Date.now()/1e3;r.forEach((o,r)=>{t.stores[e].notifications[r]=c(o,{readAt:n,seenAt:n})})}}})),s}}));function G(t,n,o={source:"any"}){e(()=>{const e=(t={})=>{"remote"===o.source&&"remote"!==t.source||"local"===o.source&&"local"!==t.source||n(t.data,t.source)};return N.on(t,e),()=>{N.off(t,e)}},[])}function T(){const t=X(),n=()=>t.fetchAllStores({page:1},{reset:!0});return function(){const t=M();e(()=>t.ws?function(t){let e=!1;const{channel:n}=t,o=function(t){const{serverURL:e}=P.getState(),n=`${e}/${t.authUrl}`,o=O();return new m.Realtime({authUrl:n,authHeaders:o,authMethod:"POST",log:{level:0},transports:["web_socket"]})}(t);o.connection.on("suspended",t=>{"disconnected"===t.previous&&D("disconnected",t,"local")}),o.connection.on(t=>{const{current:n,previous:o}=t;["suspended","disconnected"].includes(o)&&"connecting"===n&&(e=!0),e&&"connected"===n&&(e=!1,D("reconnected",t,"local"))});const r=o.channels.get(n);return r.subscribe(F),()=>{r.unsubscribe(F),r.detach(),o.connection.off(),o.close()}}(t.ws):()=>{},[t.ws])}(),G("reconnected",n),G("notifications.new",()=>t.fetchAllStores({page:1},{prepend:!0}),{source:"remote"}),G("notifications.seen.all",()=>t.markAllAsSeen({persist:!1}),{source:"remote"}),G("notifications.read.all",()=>t.markAllAsRead({persist:!1}),{source:"remote"}),G("notifications.read",n,{source:"remote"}),G("notifications.unread",n,{source:"remote"}),G("notifications.delete",e=>t.deleteNotification(e,{persist:!1}),{source:"remote"}),null}const H=["serverURL"],J=["children","stores","disableRealtime"];function Q(t){let{serverURL:e}=t;const n=w(t,H);return e&&(n.serverURL=e),P.setState(n),n}function V(o){let{children:r,stores:s=[{id:"default",defaultQueryParams:{}}],disableRealtime:i}=o,a=w(o,J);n(()=>Q(a)),n(()=>function(t){const e={};return t.forEach(t=>{const{defaultQueryParams:n,defaults:o={}}=t;e[t.id]=$(v({context:n},o))}),X.setState({stores:e}),e}(s));const c=M();return e(()=>{c.lastFetchedAt||c.fetch()},[c]),t.createElement(t.Fragment,null,i?null:t.createElement(T,null),r)}function Y(t="default"){const{stores:n,fetchStore:o,markAllAsSeen:r,markAllAsRead:s}=X(),i=M(),a=n[t],c=(e,n)=>o(t,e,n);return e(()=>{a&&i.lastFetchedAt&&!a.lastFetchedAt&&c({page:1})},[i.lastFetchedAt]),a?v({},a,{isEmpty:0===a.notifications.length,hasNextPage:a.currentPage<a.totalPages,fetch:c,fetchNextPage:(e={},n)=>o(t,v({},e,{page:a.currentPage+1}),n),markAllAsSeen:r,markAllAsRead:s}):null}function q({storeId:t}={}){const e=Y(t);return e?v({},e,{markAllAsSeen:()=>e&&e.unseenCount>0?null==e?void 0:e.markAllAsSeen({updateModels:!1}):Promise.resolve(!0)}):null}function W(t){return t?Z(1e3*t):null}function Z(t){return A(t)}function tt(t){return A(t).unix()}function et(t){if(u(t))return null;if("string"==typeof t)try{return JSON.parse(t)}catch(t){console.warn('"customAttributes" is not valid JSON')}return t}function nt(t){const{markNotificationAsRead:e,markNotificationAsSeen:n,markNotificationAsUnread:o,deleteNotification:r}=X();return v({},t,{customAttributes:et(t.customAttributes),readAt:W(t.readAt),seenAt:W(t.seenAt),sentAt:W(t.sentAt),archivedAt:W(t.archivedAt),isSeen:!u(t.seenAt),isRead:!u(t.readAt),isArchived:!u(t.archivedAt),sanitizedContent:t.content,markAsSeen:()=>n(t),markAsRead:()=>e(t),markAsUnread:()=>o(t),delete:()=>r(t)})}function ot(t,n){e(()=>()=>{n?n(t):t.markAsSeen()},[])}function rt(t,e){const n=nt(t);return ot(n,e),n}A.extend(p),A.extend(y),A.extend(g);class st{constructor(t="/notification_preferences"){this.remotePathOrUrl=void 0,this.remotePathOrUrl=t}async get(){const t=this.remotePathOrUrl,e=await C(t,void 0,{"Accept-Version":"v2"});return s.camelizeKeys(e)}async update(t){const e=this.remotePathOrUrl,n=s.decamelizeKeys({notificationPreferences:t}),o=await L(e,n,void 0,{"Accept-Version":"v2"});return s.camelizeKeys(o)}}const it=r((t,e)=>({categories:[],_repository:new st,fetch:async()=>{const{_repository:n}=e();try{const{notificationPreferences:e}=await n.get();t(v({},e,{lastFetchedAt:Date.now()}))}catch(e){t({categories:[],lastFetchedAt:Date.now()})}},save:async n=>{const{_repository:o}=e();try{const{notificationPreferences:e}=await o.update(n);t(v({},e,{lastFetchedAt:Date.now()}))}catch(e){t({categories:[],lastFetchedAt:Date.now()})}}}));export{V as MagicBellProvider,T as RealtimeListener,$ as buildStore,P as clientSettings,x as deleteAPI,N as eventAggregator,C as fetchAPI,R as postAPI,I as pushEventAggregator,L as putAPI,U as registry,W as secondsToDate,Z as toDate,tt as toUnix,q as useBell,M as useConfig,G as useMagicBellEvent,rt as useNotification,nt as useNotificationFactory,it as useNotificationPreferences,X as useNotificationStoresCollection,ot as useNotificationUnmount,Y as useNotifications};
//# sourceMappingURL=magicbell-react-headless.modern.js.map
