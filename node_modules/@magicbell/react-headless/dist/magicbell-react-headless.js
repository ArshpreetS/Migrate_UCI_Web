var e=require("react"),t=require("zustand/vanilla"),r=require("zustand"),n=require("humps"),o=require("axios"),i=require("immer"),s=require("ramda"),a=require("ably"),u=require("mitt"),c=require("dayjs"),f=require("dayjs/plugin/localizedFormat"),l=require("dayjs/plugin/relativeTime"),d=require("dayjs/plugin/updateLocale");function v(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function h(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach(function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}}),t.default=e,t}var m=/*#__PURE__*/v(e),p=/*#__PURE__*/v(t),A=/*#__PURE__*/v(r),g=/*#__PURE__*/v(n),y=/*#__PURE__*/v(o),P=/*#__PURE__*/v(i),x=/*#__PURE__*/h(a),S=/*#__PURE__*/v(u),E=/*#__PURE__*/v(c),O=/*#__PURE__*/v(f),R=/*#__PURE__*/v(l),U=/*#__PURE__*/v(d);function k(){return(k=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function w(e,t){return(w=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function b(e,t){if(null==e)return{};var r,n,o={},i=Object.keys(e);for(n=0;n<i.length;n++)t.indexOf(r=i[n])>=0||(o[r]=e[r]);return o}var C=p.default(function(){return{apiKey:"",apiSecret:void 0,userEmail:void 0,userExternalId:void 0,userKey:void 0,clientId:Math.random().toString(36).substring(2)+Date.now(),serverURL:"https://api.magicbell.com"}}),I="__MAGICBELL_HOOKS__",N="undefined"==typeof window?global:window,j={get:function(e,t){return N[I]&&N[I][e]?N[I][e]:t},set:function(e,t){N[I]=N[I]||{},N[I][e]=t}};function _(){var e=C.getState(),t=e.apiSecret,r=e.userEmail,n=e.userExternalId,o=e.userKey,i={"X-MAGICBELL-CLIENT-ID":e.clientId,"X-MAGICBELL-API-KEY":e.apiKey,"X-MagicBell-Client":"ReactHeadless/4.0.0"};return t&&(i["X-MAGICBELL-API-SECRET"]=t),r&&(i["X-MAGICBELL-USER-EMAIL"]=r),o&&(i["X-MAGICBELL-USER-HMAC"]=o),n&&(i["X-MAGICBELL-USER-EXTERNAL-ID"]=n),i}function L(e,t,r,n,o){void 0===o&&(o={});var i=C.getState().serverURL,s=k({},_(),o);return j.get("axios",y.default)({method:e,url:t,data:r,params:n,headers:s,baseURL:i}).then(function(e){return e.data},function(e){throw e})}function M(e,t,r){return void 0===t&&(t={}),L("get",e,void 0,t,r)}function q(e,t,r,n){return void 0===t&&(t={}),void 0===r&&(r={}),L("post",e,t,r,n)}function D(e,t,r){return void 0===t&&(t={}),L("delete",e,void 0,t,r)}function B(e,t,r,n){return void 0===r&&(r={}),L("put",e,t,r,n)}var F=/*#__PURE__*/function(){function e(e){void 0===e&&(e="/config"),this.remotePathOrUrl=void 0,this.remotePathOrUrl=e}return e.prototype.get=function(){try{return Promise.resolve(M(this.remotePathOrUrl)).then(function(e){return g.default.camelizeKeys(e)})}catch(e){return Promise.reject(e)}},e}(),K=A.default(function(e,t){return{channels:void 0,inbox:void 0,ws:void 0,lastFetchedAt:void 0,_repository:new F,fetch:function(){try{var r=t();return Promise.resolve(r._repository.get()).then(function(t){e(k({},t,{lastFetchedAt:Date.now()}))})}catch(e){return Promise.reject(e)}}}}),z=/*#__PURE__*/function(e){var t,r;function n(t){return void 0===t&&(t="/notifications"),e.call(this,t)||this}r=e,(t=n).prototype=Object.create(r.prototype),t.prototype.constructor=t,w(t,r);var o=n.prototype;return o.markAsRead=function(e){return q(this.remotePathOrUrl+"/"+e+"/read").then(function(){return!0}).catch(function(){return!1})},o.markAsUnread=function(e){return q(this.remotePathOrUrl+"/"+e+"/unread").then(function(){return!0}).catch(function(){return!1})},o.markAllAsSeen=function(){return q(this.remotePathOrUrl+"/seen").then(function(){return!0}).catch(function(){return!1})},o.markAllAsRead=function(){return q(this.remotePathOrUrl+"/read").then(function(){return!0}).catch(function(){return!1})},n}(/*#__PURE__*/function(){function e(e){this.remotePathOrUrl=void 0,this.remotePathOrUrl=e}var t=e.prototype;return t.get=function(e){try{return Promise.resolve(M(this.remotePathOrUrl+"/"+e)).then(function(e){return g.default.camelizeKeys(e)})}catch(e){return Promise.reject(e)}},t.findBy=function(e){try{var t=this;return Promise.resolve(function(r,n){try{var o=Promise.resolve(M(t.remotePathOrUrl,e)).then(function(e){return g.default.camelizeKeys(e)})}catch(e){return n(e)}return o&&o.then?o.then(void 0,n):o}(0,function(e){if(!/Network Error/.test(e.message))throw e}))}catch(e){return Promise.reject(e)}},t.delete=function(e){return D(this.remotePathOrUrl+"/"+e).then(function(){return!0}).catch(function(){return!1})},e}()),X=S.default(),G=S.default();function T(e,t,r){"remote"===r&&X.emit(e,t),G.emit(e,{data:t,source:r})}function H(e){var t=C.getState().clientId,r=e.name.replace(/\//gi,"."),n=e.data;return n.client_id&&n.client_id===t?Promise.resolve(!1):"string"==typeof n.id?"notifications.delete"===r?(T(r,n,"remote"),Promise.resolve(!0)):(new z).get(n.id).then(function(e){return T(r,e.notification,"remote"),!0}):(T(r,n,"remote"),Promise.resolve(!0))}function J(e){return s.mergeRight({context:{},total:0,totalPages:0,perPage:0,currentPage:1,unreadCount:0,unseenCount:0,notifications:[]},e)}var Q=["notifications"];function V(e,t){return e===t||e!=e&&t!=t}function Y(e){return Array.isArray(e)?e:String(e).split(",")}function W(e,t,r){void 0===r&&(r=V);var n=[];return Object.keys(t).forEach(function(o){var i=t[o];("read"===o&&!r(!s.isNil(e.readAt),i)||"seen"===o&&!r(!s.isNil(e.seenAt),i)||"categories"===o&&Y(i).every(function(t){return!r(e.category,t)})||"topics"===o&&Y(i).every(function(t){return!r(e.topic,t)})||Object.hasOwnProperty.call(e,o)&&!r(e[o],i))&&n.push(o)}),{result:0===n.length,delta:n}}var Z=A.default(function(e,t){return{stores:{},_repository:new z,setStore:function(t,r,n){void 0===r&&(r={}),void 0===n&&(n={}),e(P.default(function(e){e.stores[t]=J(k({},n,{context:r}))}))},fetchStore:function(r,n,o){void 0===n&&(n={}),void 0===o&&(o={});try{var i=t(),a=i._repository,u=i.stores[r];return Promise.resolve(function(){if(u)return Promise.resolve(a.findBy(k({},u.context,n))).then(function(t){t&&e(P.default(function(e){e.stores[r]=function(e,t,r){void 0===r&&(r={reset:!1});var n=t.notifications,o=b(t,Q),i=r.reset?n:s.uniqBy(function(e){return e.id},r.prepend?[].concat(n,e.notifications):[].concat(e.notifications,n));return k({context:e.context,notifications:i},o)}(u,k({},t,{lastFetchedAt:new Date}),o)}))});console.error("Store not found. Define a store with the "+r+" ID")}())}catch(e){return Promise.reject(e)}},fetchAllStores:function(e,r){void 0===e&&(e={}),void 0===r&&(r={});try{var n=t(),o=n.fetchStore,i=Object.keys(n.stores).map(function(t){return o(t,e,r)});return Promise.resolve(Promise.all(i)).then(function(){})}catch(e){return Promise.reject(e)}},markNotificationAsSeen:function(r){var n=t().stores,o=r.id;T("notifications.seen",r,"local"),e(P.default(function(e){for(var t in n){var r=n[t],i=r.notifications,a=r.unseenCount,u=s.findIndex(s.propEq("id",o),i);u>-1&&(i[u].seenAt||(e.stores[t].unseenCount=Math.max(0,a-1),e.stores[t].notifications[u]=s.mergeRight(i[u],{seenAt:Date.now()/1e3})))}}))},markNotificationAsRead:function(r){var n=t(),o=n.stores,i=r.id,a=n._repository.markAsRead(i);return T("notifications.read",r,"local"),e(P.default(function(e){var t=Date.now()/1e3,n={readAt:t,seenAt:t};for(var a in o){var u=o[a],c=u.total,f=u.notifications,l=u.context,d=s.findIndex(s.propEq("id",i),f);if(d>-1){r.readAt||(e.stores[a].unreadCount-=1),r.seenAt||(e.stores[a].unseenCount-=1);var v=s.mergeRight(f[d],n);W(v,l).result?e.stores[a].notifications[d]=v:(e.stores[a].total=Math.max(0,c-1),e.stores[a].notifications.splice(d,1))}else{var h=s.mergeRight(r,n);W(h,l).result&&(e.stores[a].total+=1,e.stores[a].notifications.push(h))}}})),a},markNotificationAsUnread:function(r){var n=t(),o=n.stores,i=r.id,a=n._repository.markAsUnread(i);return T("notifications.unread",r,"local"),e(P.default(function(e){var t={readAt:null};for(var n in o){var a=o[n],u=a.notifications,c=a.context,f=s.findIndex(s.propEq("id",i),u);if(f>-1){var l=s.mergeRight(u[f],t);W(l,c).result?(r.readAt&&(e.stores[n].unreadCount+=1),e.stores[n].notifications[f]=l):(e.stores[n].total-=1,e.stores[n].notifications.splice(f,1))}else{var d=s.mergeRight(r,t);W(d,c).result&&(e.stores[n].total+=1,r.readAt&&(e.stores[n].unreadCount+=1),e.stores[n].notifications.push(d))}}})),a},deleteNotification:function(r,n){void 0===n&&(n={});var o=t(),i=o.stores,a=o._repository,u=r.id,c=Promise.resolve(!0);return!1!==n.persist&&(c=a.delete(u),T("notifications.delete",r,"local")),e(P.default(function(e){for(var t in i){var r=i[t],n=r.notifications,o=r.total,a=r.unseenCount,c=r.unreadCount,f=s.findIndex(s.propEq("id",u),n);if(f>-1){var l=n[f];l.seenAt||(e.stores[t].unseenCount=Math.max(0,a-1)),l.readAt||(e.stores[t].unreadCount=Math.max(0,c-1)),e.stores[t].total=Math.max(0,o-1),e.stores[t].notifications.splice(f,1)}}})),c},markAllAsSeen:function(r){void 0===r&&(r={persist:!0,updateModels:!0});var n=t(),o=n.stores,i=n._repository,a=Promise.resolve(!0);return!1!==r.persist&&(a=i.markAllAsSeen(),T("notifications.seen.all",null,"local")),e(P.default(function(e){var t=function(t){var n=o[t].notifications;e.stores[t].unseenCount=0,!1!==r.updateModels&&n.forEach(function(r,n){e.stores[t].notifications[n]=s.mergeRight(r,{seenAt:Date.now()/1e3})})};for(var n in o)t(n)})),a},markAllAsRead:function(r){void 0===r&&(r={persist:!0,updateModels:!0});var n=t(),o=n.stores,i=n._repository,a=Promise.resolve(!0);return!1!==r.persist&&(a=i.markAllAsRead(),T("notifications.read.all",null,"local")),e(P.default(function(e){var t=function(t){var n=o[t].notifications;if(e.stores[t].unreadCount=0,e.stores[t].unseenCount=0,!1!==r.updateModels){var i=Date.now()/1e3;n.forEach(function(r,n){e.stores[t].notifications[n]=s.mergeRight(r,{readAt:i,seenAt:i})})}};for(var n in o)t(n)})),a}}});function $(t,r,n){void 0===n&&(n={source:"any"}),e.useEffect(function(){var e=function(e){void 0===e&&(e={}),"remote"===n.source&&"remote"!==e.source||"local"===n.source&&"local"!==e.source||r(e.data,e.source)};return G.on(t,e),function(){G.off(t,e)}},[])}function ee(){var t,r=Z(),n=function(){return r.fetchAllStores({page:1},{reset:!0})};return t=K(),e.useEffect(function(){return t.ws?function(e){var t=!1,r=e.channel,n=function(e){var t=C.getState().serverURL+"/"+e.authUrl,r=_();return new x.Realtime({authUrl:t,authHeaders:r,authMethod:"POST",log:{level:0},transports:["web_socket"]})}(e);n.connection.on("suspended",function(e){"disconnected"===e.previous&&T("disconnected",e,"local")}),n.connection.on(function(e){var r=e.current;["suspended","disconnected"].includes(e.previous)&&"connecting"===r&&(t=!0),t&&"connected"===r&&(t=!1,T("reconnected",e,"local"))});var o=n.channels.get(r);return o.subscribe(H),function(){o.unsubscribe(H),o.detach(),n.connection.off(),n.close()}}(t.ws):function(){}},[t.ws]),$("reconnected",n),$("notifications.new",function(){return r.fetchAllStores({page:1},{prepend:!0})},{source:"remote"}),$("notifications.seen.all",function(){return r.markAllAsSeen({persist:!1})},{source:"remote"}),$("notifications.read.all",function(){return r.markAllAsRead({persist:!1})},{source:"remote"}),$("notifications.read",n,{source:"remote"}),$("notifications.unread",n,{source:"remote"}),$("notifications.delete",function(e){return r.deleteNotification(e,{persist:!1})},{source:"remote"}),null}var te=["serverURL"],re=["children","stores","disableRealtime"];function ne(e){var t=e.serverURL,r=b(e,te);return t&&(r.serverURL=t),C.setState(r),r}function oe(t){void 0===t&&(t="default");var r=Z(),n=r.stores,o=r.fetchStore,i=r.markAllAsSeen,s=r.markAllAsRead,a=K(),u=n[t],c=function(e,r){return o(t,e,r)};return e.useEffect(function(){u&&a.lastFetchedAt&&!u.lastFetchedAt&&c({page:1})},[a.lastFetchedAt]),u?k({},u,{isEmpty:0===u.notifications.length,hasNextPage:u.currentPage<u.totalPages,fetch:c,fetchNextPage:function(e,r){return void 0===e&&(e={}),o(t,k({},e,{page:u.currentPage+1}),r)},markAllAsSeen:i,markAllAsRead:s}):null}function ie(e){return e?se(1e3*e):null}function se(e){return E.default(e)}function ae(e){if(s.isNil(e))return null;if("string"==typeof e)try{return JSON.parse(e)}catch(e){console.warn('"customAttributes" is not valid JSON')}return e}function ue(e){var t=Z(),r=t.markNotificationAsRead,n=t.markNotificationAsSeen,o=t.markNotificationAsUnread,i=t.deleteNotification;return k({},e,{customAttributes:ae(e.customAttributes),readAt:ie(e.readAt),seenAt:ie(e.seenAt),sentAt:ie(e.sentAt),archivedAt:ie(e.archivedAt),isSeen:!s.isNil(e.seenAt),isRead:!s.isNil(e.readAt),isArchived:!s.isNil(e.archivedAt),sanitizedContent:e.content,markAsSeen:function(){return n(e)},markAsRead:function(){return r(e)},markAsUnread:function(){return o(e)},delete:function(){return i(e)}})}function ce(t,r){e.useEffect(function(){return function(){r?r(t):t.markAsSeen()}},[])}E.default.extend(O.default),E.default.extend(R.default),E.default.extend(U.default);var fe=/*#__PURE__*/function(){function e(e){void 0===e&&(e="/notification_preferences"),this.remotePathOrUrl=void 0,this.remotePathOrUrl=e}var t=e.prototype;return t.get=function(){try{return Promise.resolve(M(this.remotePathOrUrl,void 0,{"Accept-Version":"v2"})).then(function(e){return g.default.camelizeKeys(e)})}catch(e){return Promise.reject(e)}},t.update=function(e){try{var t=this.remotePathOrUrl,r=g.default.decamelizeKeys({notificationPreferences:e});return Promise.resolve(B(t,r,void 0,{"Accept-Version":"v2"})).then(function(e){return g.default.camelizeKeys(e)})}catch(e){return Promise.reject(e)}},e}();function le(e,t){try{var r=e()}catch(e){return t(e)}return r&&r.then?r.then(void 0,t):r}var de=A.default(function(e,t){return{categories:[],_repository:new fe,fetch:function(){try{var r=t()._repository,n=le(function(){return Promise.resolve(r.get()).then(function(t){e(k({},t.notificationPreferences,{lastFetchedAt:Date.now()}))})},function(){e({categories:[],lastFetchedAt:Date.now()})});return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},save:function(r){try{var n=t()._repository,o=le(function(){return Promise.resolve(n.update(r)).then(function(t){e(k({},t.notificationPreferences,{lastFetchedAt:Date.now()}))})},function(){e({categories:[],lastFetchedAt:Date.now()})});return Promise.resolve(o&&o.then?o.then(function(){}):void 0)}catch(e){return Promise.reject(e)}}}});exports.MagicBellProvider=function(t){var r=t.children,n=t.stores,o=void 0===n?[{id:"default",defaultQueryParams:{}}]:n,i=t.disableRealtime,s=b(t,re);e.useState(function(){return ne(s)}),e.useState(function(){return function(e){var t={};return e.forEach(function(e){var r=e.defaults;t[e.id]=J(k({context:e.defaultQueryParams},void 0===r?{}:r))}),Z.setState({stores:t}),t}(o)});var a=K();return e.useEffect(function(){a.lastFetchedAt||a.fetch()},[a]),m.default.createElement(m.default.Fragment,null,i?null:m.default.createElement(ee,null),r)},exports.RealtimeListener=ee,exports.buildStore=J,exports.clientSettings=C,exports.deleteAPI=D,exports.eventAggregator=G,exports.fetchAPI=M,exports.postAPI=q,exports.pushEventAggregator=X,exports.putAPI=B,exports.registry=j,exports.secondsToDate=ie,exports.toDate=se,exports.toUnix=function(e){return E.default(e).unix()},exports.useBell=function(e){var t=oe((void 0===e?{}:e).storeId);return t?k({},t,{markAllAsSeen:function(){return t&&t.unseenCount>0?null==t?void 0:t.markAllAsSeen({updateModels:!1}):Promise.resolve(!0)}}):null},exports.useConfig=K,exports.useMagicBellEvent=$,exports.useNotification=function(e,t){var r=ue(e);return ce(r,t),r},exports.useNotificationFactory=ue,exports.useNotificationPreferences=de,exports.useNotificationStoresCollection=Z,exports.useNotificationUnmount=ce,exports.useNotifications=oe;
//# sourceMappingURL=magicbell-react-headless.js.map
